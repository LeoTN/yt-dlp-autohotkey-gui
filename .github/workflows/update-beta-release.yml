name: Update Latest Beta Release

on:
    push:
        branches: 
            - development

jobs:
    figure_out_release_version:
        name: Evaluate Correct Beta Release Version
        runs-on: windows-latest
        outputs:
          beta_version: ${{ steps.set_latest_release_version_id.outputs.FINAL_BETA_VERSION }}

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v2

            - name: Get Latest Release Version
              run: |
                $response = Invoke-WebRequest -Uri "https://api.github.com/repos/LeoTN/yt-dlp-autohotkey-gui/tags" -Method Get
                $latestTag = ($response.Content | ConvertFrom-Json)[0].name
                echo "The received tag name is $latestTag"
                Write-Host "##vso[task.setvariable variable=latestTag]$latestTag"

            - name: Figure Out Beta Release Version
              id: set_latest_release_version_id
              run: |
                $currentVersion = [String]$env:latestTag
                $finalVersion = "0.0.0"
                if ($currentVersion -like "*-beta") {
                    $currentVersion = $currentVersion.Replace("-beta", "")  
                }
                $finalVersion = $currentVersion
                Write-Host "The beta version will be $finalVersion"
                if ($finalVersion -eq "") {
                  echo "Empty version! Exiting workflow..."   
                  throw
                }
                echo "FINAL_BETA_VERSION=$finalVersion" >> $GITHUB_OUTPUT
    
    start_ci_workflow:
        name: Launch Release Workflow
        needs: figure_out_release_version
        permissions:
          contents: write
        uses: ./.github/workflows/build-installer-archive.yml
        with:
          version: ${{ needs.figure_out_release_version.outputs.beta_version }}
          is_pre_release: true